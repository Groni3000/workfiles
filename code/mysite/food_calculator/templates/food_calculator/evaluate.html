{% extends 'mainpages/layout.html' %}

{% load widget_tweaks %}

{% load insert_attrs_into_tag %}

{% block title %} Calculator {% endblock %}

{% block heading %} Calculator {% endblock%}

{% block content %}
<!--First row-->
<div class="row mt-4">
    <!--First collomn-->
    <div class="col-6 col-md-6">
        <!--GET-->
        {% if request.method == "GET" %}
            <!--IF AUTH == TRUE-->
            {% if user.is_authenticated %}

            <!--END if auth == true-->
            {% else %}
            <!--IF AUTH == FALSE-->
                <div class="row ml-3">
                    <label class="input-group-text" style="width: fit-content;" for="inputGroupSelect01">Select with Search</label>
                    <form action="{% url 'eval' %}" class="my_form" method="POST">
                        {%csrf_token%}
                        {% for field in form %}
                            {% render_field field type="select" class="selectpicker" name="food" data-style="btn-primary" data-width="auto" multiple="true" data-selected-text-format="count > 2" data-live-search="true" data-actions-box="true"%}
                        {% endfor %}
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
            <!--END if auth == false-->
            {% endif %}
        <!--end of GET-->
        {% else %}
        <!--POST-->
            <!--IF AUTH == TRUE-->
            {% if user.is_authenticated %}

            <!--END if auth == true-->
            {% else %}
            <!--IF AUTH == FALSE-->
            <h3 class='ml-2'>Тут будет какая-то мотивация для человека, что бы он старался придерживаться здорового образа жизни. Ну и немного рандомного латинского текста, что бы не пусто было.</h3>
            {% lorem 10 p random %}
            <!--END if auth == false-->
            {% endif %}
        <!--end of POST-->
        {% endif %}
    </div>
    <!--END of first collumn-->

    <!-- BELOW FIRST COLLUMN -->
    {% if request.method == "GET" %}
    <!--IF AUTH == TRUE-->
    {% if user.is_authenticated %}
        <form class="form-inline" action="{% url 'eval' %}", method="POST">
            {% csrf_token %}
            <table class="table table-striped table-hover ml-1" >
                <tr>
                    <th>Monday</th>
                    <th>Tuesday</th>
                    <th>Wednesday</th>
                    <th>Thursday</th>
                    <th>Friday</th>
                    <th>Saturday</th>
                    <th>Sunday</th>
                    <td style="background-color: rgb(161, 188, 236);">
                        <button class="btn btn-primary" type="submit">Submit</button>
                    </td>
                </tr>
                <tr>
                    {% for field in form %}
                    {% if field.field.widget.input_type == 'text' %}
                        <td>
                            {% render_field field class="form-control" style="width:100%" type="date" %}
                        </td>
                    {% endif %}
                    {% endfor %}
                    <td style="background-color: rgb(161, 188, 236);" rowspan="2">
                        Button above creates menu with current selected products. <br>
                        All your menus you can manage at your profile page. 
                    </td>
                </tr>
                <tr>
                    {% for field in form %}
                    {% if field.field.widget.input_type == 'select' %}
                    <td>
                        {% render_field field type="select" class="selectpicker" name="food" data-style="btn-primary" data-width="180px" multiple="true" data-selected-text-format="count > 2" data-live-search="true" data-actions-box="true" required="False"%}
                    </td>
                    {% endif %}
                    {% endfor %}
                </tr>
            </table>
        </form>

        
        <div class="row m-3" style="width: 100%;">
            <div class="col-sm">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" for="all_calories">All calories:</span>
                    </div>
                        <input class="form-control calories" id="all_calories" type="number" step="0.01" value="0">
                </div>
            </div>
            <div class="col-sm">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" for="all_proteins">All proteins:</span>
                    </div>
                        <input class="form-control proteins" id="all_proteins" type="number" step="0.01" value="0">
                </div>
            </div>
            <div class="col-sm">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" for="all_fats">All fats:</span>
                    </div>
                        <input class="form-control fats" id="all_fats" type="number" step="0.01" value="0">
                </div>
            </div>
            <div class="col-sm">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" for="all_carbohydrates">All carbohydrates:</span>
                    </div>
                        <input class="form-control carbohydrates" id="all_carbohydrates" type="number" step="0.01" value="0">
                </div>
            </div>
        </div>
        
        
        <div class="row mx-3" style="width: 100%;">
            <div class="col-sm" style="background-color: darkgray;">
                <label for="names-of-selected" class="form-label">Food that you have chosen:</label>
                <textarea class="form-control mb-2" style="width: 100%;" rows='1' id="names-of-selected" readonly>
                Products that you have chosen:
                </textarea>
            </div>
            <div class="col-sm" id="col_for_inputs" style="background-color: rgb(24, 26, 165); color: white;">
                <p style="text-align: center;">Names of selected products!</p>
                <div class="for-clear" id="for-clear-1"></div>
            </div>
            <div class="col-sm" id="col_for_weights" style="background-color: rgb(137, 180, 16); color: white;">
                <p style="text-align: center;">Input their weights!</p>
                <div class="for-clear" id="for-clear-2"></div>
            </div>
        </div>

        
    {% endif %}
    {% endif %}

    <!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn--><!--Second collomn-->
    <div class="col-6 col-md-6">
        <!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET--><!--GET-->
        {% if request.method == "GET" %}
            <!--IF AUTH == TRUE-->
            {% if user.is_authenticated %}

            <!--END if auth == true-->
            {% else %}
            <!--IF AUTH == FALSE-->
                <div class="container">
                    <h5 class="title_of_result">
                        Тут будут результаты выбора продуктов, сумма их калорий, белков, жиров и углеводов.
                    </h5>
                </div>
                <div class="row">
                    <label for="names-of-selected" class="form-label">Food that you have chosen:</label>
                    <textarea class="form-control ml-2" style="width: 65%;" rows='1' id="names-of-selected" readonly></textarea>
                </div>
            <!--END if auth == false-->
            {% endif %}
        <!--end of GET--><!--end of GET--><!--end of GET--><!--end of GET--><!--end of GET--><!--end of GET--><!--end of GET--><!--end of GET--><!--end of GET--><!--end of GET--><!--end of GET-->
        {% else %}
        <!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST--><!--POST-->
            <!--IF AUTH == TRUE-->
            {% if user.is_authenticated %}
                {{msg}}
            <!--END if auth == true-->
            {% else %}
            <!--IF AUTH == FALSE-->
            <div class="container">
                <h5 class="title_of_result">
                    Тут будут результаты выбора продуктов, сумма их калорий, белков, жиров и углеводов.
                </h5>
            </div>
            <textarea class="form-control mt-4" style="width: 70%;" rows='10' id="names-of-selected-post" readonly>Products that you have chosen:
                {% for el in selected_products_list %}
                    {{el}}
                {% endfor %}</textarea>

            
            {% for el in selected_products_list %}
                <div class="form-inline mt-3">
                    <div class="col-6">
                        <input class="form-control" style="width: 100%;" type="text" id="selected-prod_name-{{el}}" value="{{el}}" readonly>
                    </div>
                    <!-- 2 HIDDEN INPUTS WITH INFORMATION -->
                        <!-- First -->
                    <input class="all-info" type="text" value="{{el}};{{el.prod_calories}};{{el.prod_proteins}};{{el.prod_fats}};{{el.prod_carbohydrates}}" hidden>
                        <!-- end of first -->
                    <div class="col-2">
                        <input class="form-control multiplier" type="number" step="0.01" id="weight_of_selected-prod_name-{{el}}" placeholder="Введите вес (гр.):">
                        <!-- Second -->
                        <input class="form-control-multiplier" type="number" step="0.01" id="weight_of_selected-prod_name-{{el}}" value="0" hidden>
                        <!-- end of second -->
                    </div>
                    <!-- END OF 2 INPUTS WITH INFORMATION-->
                </div>
            {% endfor %}
            <!-- Summury calories, proteins, etc ... -->
            <p class="mt-4" id='explaining-text'>За выбранное количество выбранных продуктов Вы употребите:</p>
            <div class="form-inline">
                <input class="form-control" type="text" id="selected-prod_calories" value="0" readonly>
                <label class="ml-2" for="selected-prod_calories"> калорий;</label>
            </div>
            <div class="form-inline">
                <input class="form-control" type="text" id="selected-prod_proteins" value="0" readonly>
                <label class="ml-2" for="selected-prod_proteins"> белков;</label>
            </div>
            <div class="form-inline">
                <input class="form-control" type="text" id="selected-prod_fats" value="0" readonly>
                <label class="ml-2" for="selected-prod_fats"> жиров;</label>
            </div>
            <div class="form-inline">
                <input class="form-control" type="text" id="selected-prod_carbohydrates" value="0" readonly>
                <label class="ml-2" for="selected-prod_carbohydrates"> углеводов;</label>
            </div>
            <!-- end of summury calories, proteins, etc ... -->
            <!--END if auth == false-->
            {% endif %}
        <!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST--><!--end of POST-->
        {% endif %}
    </div>
    <!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn--><!--END of second collomn-->
</div>
<!--END of first row-->

  
{% endblock %}

{% block script %}
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>



{% if not user.is_authenticated %}
<script>
    $('.selectpicker').on('change', function(){ 
    document.getElementById('names-of-selected').innerHTML='';
    var selected = [];
    selected = $('.selectpicker').val();
    var i;
    for (i = 0; i < selected.length; i++){
        document.getElementById('names-of-selected').innerHTML+=selected[i];
        if (i!=selected.length){
            document.getElementById('names-of-selected').innerHTML+='\n';
        }
        document.getElementById('names-of-selected').setAttribute('rows',(selected.length).toString());
    }
    console.log(selected); //Get the multiple values selected in an array
    console.log(selected.length); //Length of the array
    });
</script>
{% endif %}
{% if request.method == "GET" and user.is_authenticated %}
<script>
    $("select").change(function(){ 
    all_calories = document.getElementById('all_calories');
    all_proteins = document.getElementById('all_proteins');
    all_fats = document.getElementById('all_fats');
    all_carbohydrates = document.getElementById('all_carbohydrates');
    all_calories.value=0; all_proteins.value=0; all_fats.value=0; all_carbohydrates.value=0;
    document.getElementById('names-of-selected').innerHTML='';
    var selected_monday, selected_tuesday, selected_wednesday, selected_thursday, selected_friday, selected_saturday, selected_sunday;
    var selected = [];
    var i;
    var inputs = document.getElementById("for-clear-1");
    var weights = document.getElementById("for-clear-2");
    selected_monday = $( "#id_list_of_selected_products_monday" ).val();
    selected_tuesday = $("#id_list_of_selected_products_tuesday").val();
    selected_wednesday = $("#id_list_of_selected_products_wednesday").val();
    selected_thursday = $("#id_list_of_selected_products_thursday").val();
    selected_friday = $("#id_list_of_selected_products_friday").val();
    selected_saturday = $("#id_list_of_selected_products_saturday").val();
    selected_sunday = $("#id_list_of_selected_products_sunday").val();
    selected=Array.from(new Set(selected_monday.concat(selected_tuesday,selected_wednesday,selected_thursday,selected_friday,selected_saturday,selected_sunday)));
    $('#for-clear-1').empty();
    $('#for-clear-2').empty();
    for (i = 0; i < selected.length; i++){
        document.getElementById('names-of-selected').innerHTML+=selected[i];
        if (i!=selected.length-1){
            document.getElementById('names-of-selected').innerHTML+='\n';
        }
        document.getElementById('names-of-selected').setAttribute('rows',(selected.length).toString());
        var input = document.createElement("input"), weight = document.createElement("input");
        input.type = "text"; weight.type = "number";
        input.className = "form-control inputs"; weight.className = "form-control weights";
        input.style = "margin-bottom : 10px;"; weight.style = "margin-bottom : 10px;"
        input.value = selected[i]; weight.value=0;
        input.disabled = true;
        inputs.appendChild(input); weights.appendChild(weight);
    
    
    }
    
    // console.log(selected); //Get the multiple values selected in an array
    // console.log(selected.length); //Length of the array
    });
</script>

<script>
    $(document).on("change", "input", function(){
    console.log("HI")
    var i;
    var all_products_json = JSON.parse('{{ all_products_json | escapejs }}'); //Get data for dynamic calculation
    //console.log(all_products_json['prod_name']); // format to get array of calories, proteins,...
    var all_proteins, all_calories, all_fats, all_carbohydrates;
    all_calories = document.getElementById('all_calories');
    all_proteins = document.getElementById('all_proteins');
    all_fats = document.getElementById('all_fats');
    all_carbohydrates = document.getElementById('all_carbohydrates');
    all_calories.value=0; all_proteins.value=0; all_fats.value=0; all_carbohydrates.value=0;
    //prepared inputs for all results of calculation
    chosen_products = document.getElementById('names-of-selected').value.split('\n');
    //console.log(chosen_products);
    //all_products_json[chosen_products[number_of_chosen_prod]][0 or 1 or 2 or 3]; // format to get calories, proteins,...
    
    weight_inputs=document.getElementsByClassName('form-control weights');
    //Number.parseFloat(weight_inputs[0].value);  //format to get value of certain input weight
    console.log(chosen_products.length)

    for (i = 0; i < chosen_products.length; i++) {
        console.log("Starting loop")
        calories=Number.parseFloat(all_products_json[chosen_products[i]][0]).toFixed(2);
        console.log("Calories of ", i, "-th product: ", calories)
        proteins=Number.parseFloat(all_products_json[chosen_products[i]][1]).toFixed(2);
        fats=Number.parseFloat(all_products_json[chosen_products[i]][2]).toFixed(2);
        carbohydrates=Number.parseFloat(all_products_json[chosen_products[i]][3]).toFixed(2);
        console.log("Got all needed data")

        weight=Number.parseFloat(weight_inputs[i].value).toFixed(2);

        calories=(calories/100*weight).toFixed(2);
        //console.log('Evaluated ', i, '-th calories: ', calories)
        proteins=(proteins/100*weight).toFixed(2);
        fats=(fats/100*weight).toFixed(2);
        carbohydrates=(carbohydrates/100*weight).toFixed(2);

        console.log("Values assignment")
        console.log(all_calories.value,'+',calories,'=')
        all_calories.value=(Number.parseFloat(all_calories.value)+Number.parseFloat(calories)).toFixed(2);
        console.log(all_calories.value)
        all_proteins.value=(Number.parseFloat(all_proteins.value)+Number.parseFloat(proteins)).toFixed(2);
        all_fats.value=(Number.parseFloat(all_fats.value)+Number.parseFloat(fats)).toFixed(2);
        all_carbohydrates.value=(Number.parseFloat(all_carbohydrates.value)+Number.parseFloat(carbohydrates)).toFixed(2);
        console.log("Iteration completed")
    }
});
</script>
{% else %}
<script>
$("input").change(function(){
    var x=document.getElementsByClassName('all-info');
    var y=document.getElementsByClassName('form-control-multiplier');
    var z=document.getElementsByClassName('form-control multiplier')
    var all_calories=0, all_proteins=0, all_fats=0, all_carbohydrates=0;
    var i, j;

    for (i = 0; i < x.length; i++) {
        y[i].value = parseFloat(y[i].value+z[i].value)
        var xsplitted=x[i].value.split(';')
        for (j = 1; j < xsplitted.length; j++){
            xsplitted[j]=xsplitted[j].split(',')
            xsplitted[j]=parseFloat(''.concat(xsplitted[j][0],'.',xsplitted[j][1])).toFixed(2)
        }
        all_calories =  parseFloat(Number.parseFloat(all_calories+xsplitted[1]*y[i].value/100).toFixed(2));
        all_proteins =  parseFloat(Number.parseFloat(all_proteins+xsplitted[2]*y[i].value/100).toFixed(2));
        all_fats = parseFloat(Number.parseFloat(all_fats+xsplitted[3]*y[i].value/100).toFixed(2));
        all_carbohydrates = parseFloat(Number.parseFloat(all_carbohydrates+xsplitted[4]*y[i].value/100).toFixed(2));
    }
    document.getElementById('selected-prod_calories').value=all_calories
    document.getElementById('selected-prod_proteins').value=all_proteins
    document.getElementById('selected-prod_fats').value=all_fats
    document.getElementById('selected-prod_carbohydrates').value=all_carbohydrates
    
    for (i = 0; i < y.length; i++) {
        y[i].value=0
    }

});
</script>
{% endif %}
{% endblock %}